==================================
もうなんかやけくそでサマーオブラブ
==================================

事前準備のメモ
==============

ネットワーク
------------

- https://cacoo.com/diagrams/YToAO6tiP1WwJQEV

Vyatta
------

Transparent Proxy
^^^^^^^^^^^^^^^^^

透過プロキシの設定は必要ない

- デフォルトで透過プロキシ設定なので、Squidの起動さえ確認できれば良い

  - http://terrasense.wordpress.com/2011/03/13/vyattawebproxy/

X-Forwarded-For
^^^^^^^^^^^^^^^

- http://www.vyatta.org/forum/viewtopic.php?p=69266&sid=05702179a928d6547881f89b79064935

- /etc/squid3/local.conf に追記すれば forwarded_for off が on で上書きされる

  - https://gist.github.com/1145853

::

  forwarded_off on

Parent Proxy
^^^^^^^^^^^^

プログラマブルな親プロキシを用いて、複雑な処理や状況にあわせたWebアプリケーションを作成する

- ToDo

  - /etc/squid3/local.conf に追記すればよいのかな

SNMP
----

BridgeMIB
^^^^^^^^^

- RFC 1493

  - IETF / http://www.faqs.org/rfcs/rfc1493.html

  - DD-WRT / http://www.dd-wrt.com/forum/viewtopic.php?t=2443

- IEEE

  - http://www.ieee802.org/1/pages/MIBS.html

    - http://www.ieee802.org/1/files/public/MIBs/IEEE8021-BRIDGE-MIB-200810150000Z.txt


WiFi
----
- 混雑した RF 空間の場合での設定

  - "802.11b-1999 Higher Speed Physical Layer Extension in the 2.4 GHz band" / http://standards.ieee.org/getieee802/download/802.11b-1999.pdf

  - DD-WRT - Atheros wireless settigs / http://www.dd-wrt.com/wiki/index.php/Atheros/ath_wireless_settings

  - 802 Channel Freq Mappings.pdf / http://download.wcvirtual.com/reference/802%20Channel%20Freq%20Mappings.pdf

  - 802.11b/802.11g の信号スペクトル / http://ribf.riken.jp/comp/spectra.html


課題や反省点
============

設営のノウハウについての反省点など
----------------------------------

- 養生テープとマジックは必須

  - あればあっただけ使う

- LANケーブル、電源タップはあればあるだけ使う

  - いろんな長さも合わせてストックが必要

SNMPマネージャなどの監視の設定を甘くみていた
--------------------------------------------

- 特に無線LANアクセスポイントに接続しているクライアント数を記録したかったが対応が遅くなってしまった

- munin罰の発生

  - 設定や挙動がブラックボックスになってて、どこでとまってるのか特定できずに一晩費やして結局動かせず

  - mrtg のほうがトラフィックのみ表示されてシンプルでよかった

    - トラフィック以外を出力する方法がわからないが・・・

    - トラフィック以外も snmp で扱えるものほとんど扱えるが欠点もある

      - 標準入力からも表示できるけど、自然数しか扱えない

      - 1つのグラフに2つ以上プロットできない

      - mrtg のバッドノウハウならいろいろ知ってるけど正直捨てるべきと思う

      - ただ 今回みたいに snmp で何か見に行くだけなら設定はすぐできるので mrtg でもよかったかもしれない

  - snmpgetコマンドでほしいデータだけ収集して別のサーバーに投げるスクリプト書くほうが気楽かもしれない

    - munin とかが mrtg 以下である予感がしないので、ほしいデータだけ収集するのは簡単にできそうな予感


ネットワーク全般のトラブルなど
------------------------------

- IEEE 802.11a/b/g/n の対応状況の把握

  - iPhone 4で 11a が使えると思っていたことなど

  - 11b の 14ch での iPhone で名前が引けない件

    - 再現性がない

- アクセスポイントあたりに接続するユーザ数が増えると機器が正常に動かない

  - アクセスポイントが出力する電波強度をわざと弱くし、物理的な配置を考えるなどすればよいかもしれない

    - 出力落とすと熱も減って暴走防止で一石二鳥！

  - 無線LANアクセスポイントのリソースについての考察

    - a, b/g の AP で a, b/g 両方出すと、片方しか出してないより限界が近くなるかもしれない

  - 電波の時空間的限界についての考察

    - 速度を犠牲にしても衝突を抑制する設定ができるはずなので調べる(atheros とかを要 hack かもしれない)

      + RTS/CTS 両方有効に. デフォルトで無効の可能性がある

      + RTS Threshold を大幅に小さく 

      + RTS Retry Limit を若干大きく 

      + ACK Timing を大幅に大きく 

      + 11g なら Maximum Rate を下げる


    - アナライザで解析したい

    - *UNIT* 側の WiFi は切ってもらえたが、実際は地下にもかかわらずポータブル WiFi ルータの持ち込みやビル管理用と思われる 11n の電波が出ていた

- 上流ルーターへの名前解決でインターネット崩壊

  - 8.8.8.8, 8.8.4.4 のような強い公開DNSとキャッシュで乗り切りましょう

    - でもそのぶん上流ルータのセッション数食う?

- 上流ルータのセッション数問題

  - vyatta が耐えても上流が家庭用ブロードバンドルータでは崩壊するかも

    - 上流次第で vyatta が PPPoE するとか

      - 交渉が難しそう

    - セッション数が多くてもトラフィックが多くないなら VPN はどうか


- 適切な無線LANアクセスポイントへの誘導

  - 11a 対応の機材は 11a につないでもらうような誘導が必要

  - ひとつのAPに集中しないようにする

    - 今回は ESSID: yakesummer に集中してしまった

      - イベント名と同名の名前なので集中してしまったと思われる

    - 来場者にみえるように混雑状況を表示するなどの方法で混雑を回避できるかもしれない

      - 混雑状況は無線LANアクセスポイントへの接続数などを指標にできる

- 管理側のマシンは、有線でも接続できるようにハブを用意したい

  - WiFiの状態を確認するのにいちいち切断しなくてはいけないのが面倒

Vyattaのトラブルなど
--------------------

- VyattaマシンにNICをさすたびに eth0, eth1, eth2, ... とインターフェース名が変化してしまう

  - 固定する方法があったはずなので調べる

- VLANのポートと機器の対応が分からなくなった

  - ちゃんとメモし、最新の状況でメモをアップデートしましょう

- Vyatta の ip_conntrack 数は時間帯ごとに大きく上下することがわかった

  - 盛り上がって端末なんかいじってられないときもありそう

  - 他の情報とあわせて使ったら面白い

  - グラフにしたり見た目かっこいい感じで出力できたら他の用途にも使える
    
    - プロジェクターで投影など

  - 無線LANアクセスポイントごとの接続数も表示できればよりよい

- **Vyatta 箱 (NAT, dhcpd, dnsmasq) 自体の問題はほとんど起こらなかった**

  - 最大接続数はおよそ150ほどであったと記憶している
  
    - もう少し多かったかも
  
  - ip_conntrack 数は 3000 強ほどを確認 (見かけた限りでの大きな数字)

ハードウェアのトラブル
----------------------

- @mapi の ALIENWARE マシンはクズ

  - ネットワークの設定ではなくて、検証にしようしているマシンの不具合も疑おう

  - ただし ALIENWARE は 11b の 14ch 拾えるからスゴイ

- PoE(Power over Ether)給電対応のスイッチほしい！

  - KANEKURE

  - AP 関係で AC タップ不足になるなら、5V/30Aくらい出せる電源から並列に取る方法もある

- USB NIC罰

  - PCIかExpressカードがついてるものがよいかもしれない

    - 金くれ



